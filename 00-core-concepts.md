# UCAgent æ ¸å¿ƒæ¦‚å¿µ

**çœæµç‰ˆ**ï¼š

æœ¬æ–‡è®²è§£ UCAgent çš„ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µï¼š
- **Stage**ï¼ˆå®šä¹‰"åšä»€ä¹ˆ"ï¼‰ï¼šé€šè¿‡ YAML é…ç½®éªŒè¯æµç¨‹ï¼Œæ”¯æŒåµŒå¥—ç»“æ„
- **Agent**ï¼ˆæ‰§è¡Œ"æ€ä¹ˆåš"ï¼‰ï¼šLLM é€šè¿‡ ReAct å¾ªç¯ï¼ˆæ¨ç† â†’ è¡ŒåŠ¨ â†’ è§‚å¯Ÿï¼‰è°ƒç”¨å·¥å…·å®Œæˆä»»åŠ¡
- **Checker**ï¼ˆéªŒè¯"åšå®Œäº†å—"ï¼‰ï¼šæ‰§è¡Œ pytest ç­‰æ£€æŸ¥ç¡®è®¤å®Œæˆ

ä»¥åŠé…ç½®è¯´æ˜ï¼š
  - å¿…é¡»æä¾›ï¼šå·¥ä½œç›®å½•ã€LLM API é…ç½®
  - å·²æä¾›ï¼šSystem Promptã€Stage é…ç½®ã€å·¥å…·ã€Checker
  - å¯å®šåˆ¶ï¼šStage æµç¨‹ã€Promptã€Checkerã€å·¥å…·

æ ¸å¿ƒè®¾è®¡ï¼šé…ç½®é©±åŠ¨ã€åŠ¨æ€è·å–ä»»åŠ¡ã€å®Œå…¨è‡ªåŠ¨åŒ–é—­ç¯ã€‚

---

## ğŸ¯ 1. UCAgent æ˜¯ä»€ä¹ˆï¼Ÿ

UCAgent æ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹çš„è‡ªåŠ¨åŒ–ç¡¬ä»¶éªŒè¯ç³»ç»Ÿ,è®© LLM åƒäººç±»éªŒè¯å·¥ç¨‹å¸ˆä¸€æ ·è‡ªåŠ¨å®ŒæˆèŠ¯ç‰‡éªŒè¯çš„å…¨æµç¨‹ã€‚

### 1.1 æŠ€æœ¯æ ˆæ¦‚è§ˆ

UCAgent é‡‡ç”¨ 5 å±‚æ¶æ„ï¼š

```
åº”ç”¨å±‚: UCAgent (Stageé…ç½® + CheckeréªŒè¯)
   â†“
Agentå±‚: LangGraph ReAct Agent (æ¨ç†-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯)
   â†“
LLMå±‚: ChatOpenAI (å¤§è¯­è¨€æ¨¡å‹æ¨ç†)
   â†“
éªŒè¯æ¡†æ¶å±‚: pytest + toffee (æµ‹è¯•æ‰§è¡Œå’Œç¡¬ä»¶ä»¿çœŸ)
   â†“
ä»¿çœŸå™¨å±‚: Verilator (RTLç¡¬ä»¶è¡Œä¸ºæ¨¡æ‹Ÿ)
```

**æ ¸å¿ƒä¾èµ–**ï¼š
- **LangGraph**: `create_react_agent` æä¾› ReAct æ¡†æ¶
- **pytest + toffee**: Python æµ‹è¯•æ¡†æ¶ + ç¡¬ä»¶éªŒè¯æ¥å£
- **Verilator**: å¼€æºé«˜æ€§èƒ½ RTL ä»¿çœŸå™¨

è¯¦ç»†è¯´æ˜å‚è§ [01-technology-stack.md](./01-technology-stack.md)

### 1.2 å·¥ä½œæ–¹å¼å¯¹æ¯”

**ä¼ ç»Ÿäººå·¥éªŒè¯**ï¼š
```
äººç±»å·¥ç¨‹å¸ˆè¯»æ–‡æ¡£ â†’ ç¼–å†™æµ‹è¯• â†’ æ‰§è¡Œæµ‹è¯• â†’ åˆ†æè¦†ç›–ç‡ â†’ è¡¥å……æµ‹è¯• â†’ å¾ªç¯...
```

**UCAgentè‡ªåŠ¨éªŒè¯**ï¼š
```
é…ç½®éªŒè¯æµç¨‹ â†’ LLMè‡ªåŠ¨å®Œæˆæ‰€æœ‰æ­¥éª¤ â†’ è¾“å‡ºéªŒè¯æŠ¥å‘Š
```

LLM è‡ªåŠ¨å®Œæˆï¼š
1. è¯»å–è®¾è®¡æ–‡æ¡£ï¼Œç†è§£èŠ¯ç‰‡åŠŸèƒ½
2. ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ä»£ç 
3. æ‰§è¡Œæµ‹è¯•å¹¶æ”¶é›†è¦†ç›–ç‡
4. åˆ†æç»“æœï¼Œè¡¥å……æµ‹è¯•
5. å‘ç°bugå¹¶ç”Ÿæˆåˆ†ææŠ¥å‘Š

### 1.3 ä½¿ç”¨ UCAgent çš„é…ç½®è¯´æ˜

#### 1.3.1 å¿…é¡»ç”±ä½¿ç”¨è€…æä¾›çš„é…ç½®

**å·¥ä½œç›®å½•ç»“æ„**ï¼š
```
workspace/
â”œâ”€â”€ README.md              # å¿…é¡»ï¼šDUT åŠŸèƒ½è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ {DUT}/                 # å¿…é¡»ï¼šDUT æºç ç›®å½•ï¼ˆVerilog/Scalaç­‰ï¼‰
â”‚   â”œâ”€â”€ *.v / *.scala      # RTL è®¾è®¡æ–‡ä»¶
â”‚   â””â”€â”€ __init__.py        # Python æ¥å£æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ Guide_Doc/             # å¯é€‰ï¼šé¢å¤–çš„æŒ‡å¯¼æ–‡æ¡£
    â””â”€â”€ *.md
```

**å‘½ä»¤è¡Œå‚æ•°**ï¼š
```bash
ucagent <workspace> <dut_name> [é€‰é¡¹]
```
- `workspace`: å·¥ä½œç›®å½•è·¯å¾„ï¼ˆå¿…é¡»ï¼‰
- `dut_name`: è¢«æµ‹è®¾è®¡åç§°ï¼ˆå¿…é¡»ï¼‰
- `--config`: è‡ªå®šä¹‰é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
- `--interaction-mode`: äº¤äº’æ¨¡å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤ standardï¼‰

**LLM API é…ç½®**ï¼ˆå¿…é¡»åœ¨é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡ä¸­æä¾›ï¼‰ï¼š
```yaml
# OpenAI é…ç½®
model_type: "openai"
openai:
  openai_api_key: "your-key"
  openai_api_base: "https://api.openai.com/v1"
  model_name: "gpt-4"

# æˆ– Anthropic é…ç½®
model_type: "anthropic"
anthropic:
  api_key: "your-key"
  model: "claude-3-5-sonnet-20241022"
```

#### 1.3.2 UCAgent å·²ç»æä¾›çš„é…ç½®

**é»˜è®¤é…ç½®æ–‡ä»¶**ï¼š`UCAgent/ucagent/lang/zh/config/default.yaml`

**å·²æä¾›çš„å†…å®¹**ï¼š
1. **System Prompt**ï¼ˆç¬¬ 19-87 è¡Œï¼‰
   - å®šä¹‰ LLM çš„è§’è‰²å’Œå·¥ä½œæ–¹å¼
   - æ— éœ€ä¿®æ”¹ï¼Œå¼€ç®±å³ç”¨

2. **Stage é…ç½®**ï¼ˆç¬¬ 93-725 è¡Œï¼‰
   - 10 ä¸ªæ ‡å‡†éªŒè¯é˜¶æ®µ
   - æ¯ä¸ªé˜¶æ®µçš„ä»»åŠ¡æè¿°ã€å‚è€ƒæ–‡ä»¶ã€è¾“å‡ºæ–‡ä»¶
   - é€‚ç”¨äºå¤§å¤šæ•°èŠ¯ç‰‡éªŒè¯åœºæ™¯

3. **å·¥å…·é…ç½®**
   - æ–‡ä»¶æ“ä½œå·¥å…·ï¼ˆReadTextFile, WriteTextFile ç­‰ï¼‰
   - ä»»åŠ¡ç®¡ç†å·¥å…·ï¼ˆCheck, Complete ç­‰ï¼‰
   - æµ‹è¯•æ‰§è¡Œå·¥å…·ï¼ˆRunTestCases ç­‰ï¼‰

4. **Checker é…ç½®**
   - UnityTestCheckerï¼ˆpytest æµ‹è¯•ï¼‰
   - BashScriptCheckerï¼ˆè„šæœ¬æ‰§è¡Œï¼‰
   - HumanCheckerï¼ˆäººå·¥å®¡æŸ¥ï¼‰

#### 1.3.3 æ”¯æŒè‡ªå®šä¹‰çš„é…ç½®

**å¯å®šåˆ¶çš„é…ç½®é¡¹**ï¼š

1. **Stage æµç¨‹å®šåˆ¶**
   ```yaml
   # åœ¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ä¸­è¦†ç›–é»˜è®¤ Stage
   stage:
     - name: custom_stage_1
       desc: "è‡ªå®šä¹‰é˜¶æ®µæè¿°"
       task:
         - "è‡ªå®šä¹‰ä»»åŠ¡æ­¥éª¤1"
         - "è‡ªå®šä¹‰ä»»åŠ¡æ­¥éª¤2"
       reference_files:
         - "custom_doc.md"
       output_files:
         - "custom_output/*.py"
       checker:
         - clss: "CustomChecker"
   ```

2. **System Prompt å®šåˆ¶**
   ```yaml
   # è¦†ç›–é»˜è®¤çš„ System Prompt
   mission:
     system_prompt: |
       ä½ æ˜¯ä¸€ä¸ªä¸“é—¨é’ˆå¯¹ RISC-V å¤„ç†å™¨çš„éªŒè¯ä¸“å®¶...
   ```

3. **Checker å®šåˆ¶**
   ```python
   # åˆ›å»ºè‡ªå®šä¹‰ Checker
   from ucagent.checkers.base import UCChecker

   class CustomChecker(UCChecker):
       def do_check(self, *args, **kwargs):
           # è‡ªå®šä¹‰æ£€æŸ¥é€»è¾‘
           return True, "æ£€æŸ¥é€šè¿‡"
   ```

4. **å·¥å…·å®šåˆ¶**
   ```python
   # æ·»åŠ è‡ªå®šä¹‰å·¥å…·
   from ucagent.tools.uctool import UCTool

   class CustomTool(UCTool):
       name = "CustomTool"
       description = "è‡ªå®šä¹‰å·¥å…·æè¿°"

       def _run(self, *args, **kwargs):
           # è‡ªå®šä¹‰å·¥å…·é€»è¾‘
           return "å·¥å…·æ‰§è¡Œç»“æœ"
   ```

5. **æ¨¡å‹å‚æ•°å®šåˆ¶**
   ```yaml
   # è°ƒæ•´ LLM å‚æ•°
   openai:
     temperature: 0.7        # åˆ›é€ æ€§ï¼ˆ0-1ï¼‰
     max_tokens: 4096        # æœ€å¤§è¾“å‡ºé•¿åº¦
     top_p: 0.9              # é‡‡æ ·å‚æ•°
   ```

**é…ç½®ä¼˜å…ˆçº§**ï¼š
```
å‘½ä»¤è¡Œå‚æ•° > è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ > é»˜è®¤é…ç½®æ–‡ä»¶
```

---

## ğŸ”‘ 2. ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ

UCAgent çš„æ¶æ„åŸºäºä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š**Stage**ã€**Agent**ã€**Checker**ã€‚

### 2.1 Stageï¼ˆé˜¶æ®µï¼‰- "åšä»€ä¹ˆ"

**Stage å®šä¹‰äº†éªŒè¯æµç¨‹çš„æ¯ä¸€æ­¥éœ€è¦åšä»€ä¹ˆ**ã€‚

#### é…ç½®ç¤ºä¾‹

```yaml
# é…ç½®æ–‡ä»¶ï¼šdefault.yaml
stage:
  - name: requirement_analysis_and_planning
    desc: "éœ€æ±‚åˆ†æä¸éªŒè¯è§„åˆ’"
    task:
      - "ç¬¬1æ­¥ï¼šè¯»å–README.mdï¼Œç†è§£éªŒè¯è¦æ±‚"
      - "ç¬¬2æ­¥ï¼šç¡®å®šéªŒè¯ç›®æ ‡"
      - "ç¬¬3æ­¥ï¼šè¯†åˆ«é£é™©ç‚¹"
    reference_files:
      - "README.md"
    output_files:
      - "unity_test/verification_plan.md"
    checker:
      - clss: "UnityTestChecker"
```

#### Stage çš„ç»„æˆéƒ¨åˆ†

1. **name**: é˜¶æ®µåç§°ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
2. **desc**: é˜¶æ®µæè¿°ï¼ˆå‘Šè¯‰LLMè¿™ä¸ªé˜¶æ®µçš„ç›®æ ‡ï¼‰
3. **task**: ä»»åŠ¡åˆ—è¡¨ï¼ˆå…·ä½“çš„æ‰§è¡Œæ­¥éª¤ï¼‰
4. **reference_files**: å¿…é¡»è¯»å–çš„å‚è€ƒæ–‡ä»¶
5. **output_files**: å¿…é¡»ç”Ÿæˆçš„è¾“å‡ºæ–‡ä»¶
6. **checker**: éªŒè¯å®Œæˆçš„æ£€æŸ¥å™¨

#### Stage çš„åµŒå¥—ç»“æ„

Stage æ”¯æŒåµŒå¥—ï¼Œå¯ä»¥åŒ…å«å­ Stageï¼š

```yaml
stage:
  - name: test_implementation
    desc: "æµ‹è¯•å®ç°"
    stage:  # å­é˜¶æ®µ
      - name: basic_test
        desc: "åŸºç¡€æµ‹è¯•"
      - name: corner_case_test
        desc: "è¾¹ç•Œæµ‹è¯•"
```

**æ‰§è¡Œé¡ºåº**ï¼šå­Stage â†’ çˆ¶Stage
- å…ˆå®Œæˆ `basic_test`
- å†å®Œæˆ `corner_case_test`
- æœ€åå®Œæˆ `test_implementation`

### 2.2 Agentï¼ˆæ‰§è¡Œè€…ï¼‰- "æ€ä¹ˆåš"

**Agent æ˜¯ LLM + LangGraph ReAct æ¡†æ¶ï¼Œé€šè¿‡ ReAct å¾ªç¯æ¥å®Œæˆ Stage å®šä¹‰çš„ä»»åŠ¡**ã€‚

#### Agent çš„æ„æˆ

**æºç ä½ç½®**: `verify_agent.py:255-261`

```python
from langgraph.prebuilt import create_react_agent

self.agent = create_react_agent(
    model=self.model,              # LLM æ¨¡å‹ (ChatOpenAI)
    tools=self.test_tools,         # å·¥å…·åˆ—è¡¨
    checkpointer=MemorySaver(),    # å¯¹è¯å†å²ä¿å­˜
    pre_model_hook=message_manage_node,  # æ¶ˆæ¯ç®¡ç†
    state_schema=State,            # çŠ¶æ€æ¨¡å¼
)
```

**å…³é”®ç‚¹**:
- `create_react_agent` æ˜¯ LangGraph æä¾›çš„**é¢„æ„å»º ReAct Agent**
- Agent çš„è¡Œä¸ºæ¨¡å¼ç”± **LangGraph æ¡†æ¶å†…éƒ¨å®ç°**ï¼Œä¸æ˜¯ UCAgent è‡ªå·±å†™çš„
- UCAgent åªè´Ÿè´£æä¾›å·¥å…·åˆ—è¡¨å’Œ System Prompt

#### ReAct å¾ªç¯æœºåˆ¶

ReAct = **Rea**soningï¼ˆæ¨ç†ï¼‰+ **Act**ingï¼ˆè¡ŒåŠ¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Reasoning (æ¨ç†)                 â”‚
â”‚     LLM: "æˆ‘éœ€è¦å…ˆè¯»READMEäº†è§£åŠŸèƒ½"   â”‚
â”‚     [ç”± LLM æ ¹æ® Prompt å†³å®š]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Acting (è¡ŒåŠ¨)                    â”‚
â”‚     è°ƒç”¨å·¥å…·: ReadTextFile("README") â”‚
â”‚     [ç”± LangGraph è‡ªåŠ¨æ‰§è¡Œ]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Observation (è§‚å¯Ÿ)               â”‚
â”‚     æ”¶åˆ°: READMEå†…å®¹                 â”‚
â”‚     [ç”± LangGraph è¿”å›ç»™ LLM]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
         å›åˆ°æ­¥éª¤1ï¼Œç»§ç»­æ¨ç†...
```

**Agent è¡Œä¸ºçš„æ§åˆ¶å±‚æ¬¡**:
- **ReAct å¾ªç¯æœ¬èº«**: ç”± LangGraph æ¡†æ¶æ§åˆ¶ï¼ˆå›ºåŒ–åœ¨ `create_react_agent` ä¸­ï¼‰
- **å…·ä½“è¡ŒåŠ¨å†…å®¹**: ç”± LLM æ ¹æ® System Prompt å†³å®š
- **å¯ç”¨å·¥å…·**: ç”± UCAgent æä¾›ï¼ˆCheck, Complete, ReadTextFile ç­‰ï¼‰

#### å®é™…æ¡ˆä¾‹

å‡è®¾å½“å‰ Stage çš„ä»»åŠ¡æ˜¯"ç”ŸæˆAPIæµ‹è¯•"ï¼š

```
è½®æ¬¡1ï¼š
  Reasoning: æˆ‘éœ€è¦å…ˆäº†è§£èŠ¯ç‰‡åŠŸèƒ½
  Acting: ReadTextFile("README.md")
  Observation: [READMEå†…å®¹]

è½®æ¬¡2ï¼š
  Reasoning: æˆ‘éœ€è¦äº†è§£APIæ¥å£å®šä¹‰
  Acting: ReadTextFile("Adder/__init__.py")
  Observation: [æ¥å£å®šä¹‰]

è½®æ¬¡3ï¼š
  Reasoning: ç°åœ¨å¯ä»¥ç”Ÿæˆæµ‹è¯•ä»£ç äº†
  Acting: WriteTextFile("tests/test_api.py", code)
  Observation: "å†™å…¥æˆåŠŸ"

è½®æ¬¡4ï¼š
  Reasoning: éœ€è¦æ£€æŸ¥æµ‹è¯•æ˜¯å¦é€šè¿‡
  Acting: Check()
  Observation: "æµ‹è¯•é€šè¿‡"

è½®æ¬¡5ï¼š
  Acting: Complete()
  Observation: "è¿›å…¥ä¸‹ä¸€é˜¶æ®µ"
```

#### pytest æµ‹è¯•ä»£ç çš„ç”Ÿæˆæœºåˆ¶

pytest æµ‹è¯•ä»£ç ç”± LLM è‡ªåŠ¨ç”Ÿæˆã€‚

**å®Œæ•´æµç¨‹**:
```
1. Stage é…ç½®å®šä¹‰ä»»åŠ¡
   â†“
2. LLM æ ¹æ® Prompt å’Œä»»åŠ¡æè¿°ç”Ÿæˆæµ‹è¯•ä»£ç 
   â†“
3. LLM è°ƒç”¨ WriteTextFile å·¥å…·å†™å…¥æµ‹è¯•æ–‡ä»¶
   â†“
4. LLM è°ƒç”¨ Check å·¥å…·éªŒè¯
   â†“
5. Checker é€šè¿‡ subprocess æ‰§è¡Œ pytest
   â†“
6. pytest åŠ è½½æµ‹è¯•æ–‡ä»¶å¹¶æ‰§è¡Œ
   â†“
7. toffee æä¾›ç¡¬ä»¶ä»¿çœŸæ¥å£
   â†“
8. Verilator æ‰§è¡Œ RTL ä»¿çœŸ
```

**æºç è¯æ®**:
- **æµ‹è¯•ä»£ç ç”Ÿæˆ**: LLM é€šè¿‡ `WriteTextFile` å·¥å…·å†™å…¥ (ç”± Prompt å¼•å¯¼)
- **pytest æ‰§è¡Œ**: `UnityTestChecker.do_check()` è°ƒç”¨ `subprocess.run(["pytest", ...])`
- **é…ç½®ä½ç½®**: `default.yaml` ä¸­çš„ Stage é…ç½®æŒ‡å®šä½¿ç”¨å“ªä¸ª Checker

### 2.3 Checkerï¼ˆæ£€æŸ¥å™¨ï¼‰- "åšå®Œäº†å—"

**Checker éªŒè¯å½“å‰ Stage æ˜¯å¦å®Œæˆ**ã€‚

#### Checker çš„å·¥ä½œæµç¨‹

```python
class UnityTestChecker(Checker):
    def do_check(self):
        # 1. æ£€æŸ¥ reference_files æ˜¯å¦éƒ½å·²è¯»å–
        if not all_files_read:
            return False, "è¿˜æœ‰æ–‡ä»¶æœªè¯»å–"

        # 2. æ£€æŸ¥ output_files æ˜¯å¦éƒ½å·²ç”Ÿæˆ
        if not all_files_generated:
            return False, "è¿˜æœ‰æ–‡ä»¶æœªç”Ÿæˆ"

        # 3. æ‰§è¡Œ pytest æµ‹è¯•
        result = run_pytest()

        # 4. è¿”å›ç»“æœ
        if result.passed:
            return True, "æµ‹è¯•é€šè¿‡"
        else:
            return False, "æµ‹è¯•å¤±è´¥ï¼šè¯¦ç»†ä¿¡æ¯..."
```

#### Checker çš„ç±»å‹

1. **UnityTestChecker**: æ‰§è¡Œ pytest æµ‹è¯•
2. **BashScriptChecker**: æ‰§è¡Œ bash è„šæœ¬
3. **ToffeeReportChecker**: æ£€æŸ¥è¦†ç›–ç‡æŠ¥å‘Š
4. **HumanChecker**: éœ€è¦äººå·¥ç¡®è®¤

#### Checker çš„åé¦ˆæœºåˆ¶

Checker çš„è¿”å›å€¼ä¼šç›´æ¥åé¦ˆç»™ LLMï¼š

```python
# å¤±è´¥æ—¶
{
  "error": "è¾“å‡ºæ–‡ä»¶æœªç”Ÿæˆ",
  "failed_patterns": ["unity_test/verification_plan.md"]
}

# æˆåŠŸæ—¶
{
  "success": "æ£€æŸ¥é€šè¿‡",
  "message": "æ‰€æœ‰è¦æ±‚å·²æ»¡è¶³"
}
```

LLM æ ¹æ®åé¦ˆå†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š
- å¦‚æœå¤±è´¥ â†’ åˆ†æåŸå›  â†’ ä¿®å¤ â†’ é‡æ–° Check
- å¦‚æœæˆåŠŸ â†’ è°ƒç”¨ Complete â†’ è¿›å…¥ä¸‹ä¸€ä¸ª Stage

---

## ğŸ”„ 3. ä¸‰è€…çš„ååŒå·¥ä½œ

### 3.1 å®Œæ•´å·¥ä½œæµç¨‹

```
å¯åŠ¨ UCAgent
    â†“
åŠ è½½é…ç½®ï¼Œè§£ææ‰€æœ‰ Stage
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿›å…¥ Stage 1: éœ€æ±‚åˆ†æ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
StageManager è¿”å›å½“å‰ Stage çš„ä»»åŠ¡
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent (LLM) å¼€å§‹ ReAct å¾ªç¯         â”‚
â”‚  - æ¨ç†ï¼šéœ€è¦è¯» README               â”‚
â”‚  - è¡ŒåŠ¨ï¼šReadTextFile("README")     â”‚
â”‚  - è§‚å¯Ÿï¼šæ”¶åˆ° README å†…å®¹            â”‚
â”‚  - æ¨ç†ï¼šéœ€è¦ç”ŸæˆéªŒè¯è®¡åˆ’             â”‚
â”‚  - è¡ŒåŠ¨ï¼šWriteTextFile("plan.md")   â”‚
â”‚  - æ¨ç†ï¼šéœ€è¦æ£€æŸ¥æ˜¯å¦å®Œæˆ             â”‚
â”‚  - è¡ŒåŠ¨ï¼šCheck()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Checker æ‰§è¡Œæ£€æŸ¥                    â”‚
â”‚  - æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¯»å–                  â”‚
â”‚  - æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ                  â”‚
â”‚  - è¿”å›ç»“æœç»™ LLM                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å¦‚æœé€šè¿‡ â†’ Agent è°ƒç”¨ Complete()
    â†“
StageManager æ¨è¿›åˆ° Stage 2
    â†“
é‡å¤ä¸Šè¿°æµç¨‹...
```

### 3.2 Stage çš„åŠ è½½å’Œæ‰§è¡Œé¡ºåºæ§åˆ¶æœºåˆ¶

#### Stage çš„åŠ è½½æœºåˆ¶

Stage ç”±é…ç½®æ–‡ä»¶ (`UCAgent/ucagent/lang/zh/config/default.yaml`) å®šä¹‰,æºç è´Ÿè´£è§£æã€‚

**åŠ è½½æµç¨‹**:
```
1. UCAgent å¯åŠ¨
   â†“
2. åŠ è½½é…ç½®æ–‡ä»¶ default.yaml (verify_agent.py:112)
   â†“
3. StageManager.init_stage() è§£æé…ç½® (vmanager.py:261-310)
   â†“
4. parse_vstage() é€’å½’è§£æ Stage æ ‘ (vstage.py:367-404)
   â†“
5. get_substages() æ‰å¹³åŒ–ä¸ºçº¿æ€§åˆ—è¡¨ (vstage.py:300-306)
   â†“
6. å¾—åˆ°å¯æ‰§è¡Œçš„ Stage åˆ—è¡¨ (åªåŒ…å«å¶å­èŠ‚ç‚¹)
```

**æºç ä½ç½®**:
- é…ç½®åŠ è½½: `verify_agent.py:112` â†’ `get_config()`
- Stage è§£æ: `vmanager.py:263` â†’ `get_root_stage()`
- é€’å½’è§£æ: `vstage.py:367-404` â†’ `parse_vstage()`
- æ‰å¹³åŒ–: `vstage.py:300-306` â†’ `get_substages()`

#### Stage æ‰§è¡Œé¡ºåºçš„æ§åˆ¶æœºåˆ¶

StageManager é€šè¿‡ `stage_index` ç»´æŠ¤å½“å‰è¿›åº¦,æ§åˆ¶ Stage çš„æ‰§è¡Œé¡ºåºã€‚

**æ§åˆ¶æœºåˆ¶**:
```
StageManager ç»´æŠ¤:
- self.stages: Stage åˆ—è¡¨ (æ‰å¹³åŒ–åçš„)
- self.stage_index: å½“å‰æ‰§è¡Œåˆ°ç¬¬å‡ ä¸ª Stage

Agent é€šè¿‡å·¥å…·åŠ¨æ€è·å–:
- CurrentTips: è·å–å½“å‰ Stage çš„ä»»åŠ¡
- Complete: å®Œæˆå½“å‰ Stageï¼Œæ¨è¿› stage_index
```

**å…³é”®è®¾è®¡**: Prompt **ä¸åŒ…å«** å…·ä½“çš„ Stage åˆ—è¡¨ï¼

System Prompt åªå‘Šè¯‰ LLM:
```
å·¥ä½œæµç”±å¤šä¸ª stage ç»„æˆï¼Œæ¯ä¸ª stage åŒ…å«å…·ä½“çš„ task æè¿°ï¼Œéœ€è¦æŒ‰é¡ºåºå®Œæˆã€‚
ä½¿ç”¨å·¥å…· `CurrentTips` è·å–å½“å‰é˜¶æ®µçš„è¯¦ç»†ä»»åŠ¡æŒ‡å¯¼ã€‚
```

#### åŠ¨æ€è·å–æœºåˆ¶

**æºç ä½ç½®**: `vmanager.py:349-368`

```python
def get_current_tips(self):
    # è·å–å½“å‰ Stage
    cstage = self.stages[self.stage_index]

    # è¿”å›å½“å‰ Stage çš„ä»»åŠ¡
    tips = OrderedDict()
    tips["mission"] = self.mission.name
    tips["current_stage"] = {
        "index": self.stage_index,
        **cstage.detail(),  # task, reference_files, output_files
    }
    tips["process"] = f"{self.stage_index}/{len(self.stages)}"
    return tips
```

#### æ¨è¿›æœºåˆ¶

**æºç ä½ç½®**: `vmanager.py:522-558`

```python
def complete(self, timeout):
    # 1. æ‰§è¡Œæœ€ç»ˆæ£€æŸ¥
    ck_pass, ck_info = self.stages[self.stage_index].do_check(...)

    if ck_pass:
        # 2. å®Œæˆå½“å‰é˜¶æ®µ
        self.stages[self.stage_index].on_complete()

        # 3. æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ
        self.next_stage()  # stage_index += 1

        # 4. åˆå§‹åŒ–ä¸‹ä¸€é˜¶æ®µ
        self.stages[self.stage_index].on_init()
```

#### è®¾è®¡ä¼˜åŠ¿

1. **è§£è€¦**: Agent ä¸éœ€è¦çŸ¥é“æ‰€æœ‰ Stageï¼Œåªå…³æ³¨å½“å‰ä»»åŠ¡
2. **çµæ´»**: å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ— éœ€ä¿®æ”¹ä»£ç æˆ– Prompt
3. **å¯æ§**: StageManager å®Œå…¨æ§åˆ¶é¡ºåºï¼ŒAgent æ— æ³•è·³è¿‡
4. **å¯æ¢å¤**: ä¿å­˜ stage_index å¯å®ç°æ–­ç‚¹ç»­ä¼ 

---

## ğŸ“ 4. æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æŠ€æœ¯æ ˆ**: UCAgent = LLM + LangGraph + pytest + toffee + Verilator
2. **ä¸‰å¤§æ ¸å¿ƒ**ï¼š
   - **Stage**: å®šä¹‰"åšä»€ä¹ˆ"ï¼ˆé…ç½®åœ¨ `default.yaml` ä¸­ï¼‰
   - **Agent**: æ‰§è¡Œ"æ€ä¹ˆåš"ï¼ˆLangGraph ReAct Agent + LLMï¼‰
   - **Checker**: éªŒè¯"åšå®Œäº†å—"ï¼ˆç»§æ‰¿è‡ª `base.Checker`ï¼‰

3. **å…³é”®æ§åˆ¶æœºåˆ¶**ï¼š
   - **Agent è¡Œä¸º**: ç”± LangGraph æ¡†æ¶æ§åˆ¶ ReAct å¾ªç¯ï¼ŒPrompt å¼•å¯¼å…·ä½“è¡ŒåŠ¨
   - **Stage åŠ è½½**: é…ç½®æ–‡ä»¶å®šä¹‰ï¼Œæºç è§£æï¼ˆé€’å½’ + æ‰å¹³åŒ–ï¼‰
   - **Stage é¡ºåº**: StageManager ç»´æŠ¤ stage_indexï¼ŒAgent åŠ¨æ€è·å–
   - **æµ‹è¯•ä»£ç **: LLM ç”Ÿæˆï¼ŒChecker æ‰§è¡Œ pytest

4. **è®¾è®¡ç‰¹ç‚¹**ï¼š
   - Prompt ä¸åŒ…å« Stage åˆ—è¡¨ï¼Œé€šè¿‡å·¥å…·åŠ¨æ€è·å–
   - é…ç½®ä¸ä»£ç åˆ†ç¦»ï¼Œçµæ´»å¯æ‰©å±•
   - å®Œæ•´çš„è‡ªåŠ¨åŒ–é—­ç¯ï¼šç”Ÿæˆ â†’ æ‰§è¡Œ â†’ éªŒè¯ â†’ åé¦ˆ

---

**ä¸‹ä¸€ç« **ï¼š [01-technology-stack.md](./01-technology-stack.md)