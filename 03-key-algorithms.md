# å…³é”®ç®—æ³•æ·±åº¦è§£æ

**çœæµç‰ˆ**ï¼š

æœ¬æ–‡è®²è§£ UCAgent çš„ä¸‰ä¸ªå…³é”®ç®—æ³•å®ç°ï¼š
- **Stage é€’å½’è§£æç®—æ³•**ï¼š
  - å°† YAML é…ç½®çš„åµŒå¥— Stage ç»“æ„é€’å½’è§£æä¸º Stage æ ‘
  - é€šè¿‡ prefix å‚æ•°ç”Ÿæˆç´¢å¼•ç¼–å·ï¼ˆå¦‚ "1.1"ã€"1.2"ï¼‰
  - æºç ä½ç½®ï¼š`stage/vstage.py:367-404`
- **Stage æ ‘æ‰å¹³åŒ–ç®—æ³•**ï¼š
  - å°†æ ‘çŠ¶ç»“æ„æ‰å¹³åŒ–ä¸ºçº¿æ€§åˆ—è¡¨
  - åªä¿ç•™å¶å­èŠ‚ç‚¹æ‰§è¡Œï¼Œè·³è¿‡ç»„èŠ‚ç‚¹
  - é€šè¿‡ååºéå†ä¿è¯æ‰§è¡Œé¡ºåº
  - æºç ä½ç½®ï¼š`stage/vstage.py:300-306`
- **æ‰¹å¤„ç†ä»»åŠ¡ç®¡ç†ç®—æ³•**ï¼š
  - å°†å¤§é‡æµ‹è¯•ç”¨ä¾‹åˆ†æ‰¹ç”Ÿæˆï¼Œé¿å…ä¸€æ¬¡æ€§ç”Ÿæˆè¿‡å¤šä»£ç 
  - å››ä¸ªåˆ—è¡¨ç®¡ç†ä»»åŠ¡çŠ¶æ€ï¼šç›®æ ‡ä»»åŠ¡ã€å·²ç”Ÿæˆä»»åŠ¡ã€å¾…å®Œæˆä»»åŠ¡ã€å·²å®Œæˆä»»åŠ¡
  - æºç ä½ç½®ï¼š`checkers/base.py:309-550`

---

## ğŸŒ² 1. Stage é€’å½’è§£æç®—æ³•

### 1.1 ç®—æ³•èƒŒæ™¯

UCAgent çš„éªŒè¯æµç¨‹ç”±å¤šä¸ª Stage ç»„æˆï¼Œè¿™äº› Stage å¯ä»¥åµŒå¥—ã€‚ä¾‹å¦‚ï¼š

```yaml
stage:
  - name: "æµ‹è¯•å®ç°"
    stage:
      - name: "åŸºç¡€æµ‹è¯•"
      - name: "è¾¹ç•Œæµ‹è¯•"
  - name: "è¦†ç›–ç‡åˆ†æ"
```

è¿™ç§åµŒå¥—ç»“æ„éœ€è¦é€’å½’è§£æï¼Œå°† YAML é…ç½®è½¬æ¢ä¸º Stage æ ‘ã€‚

### 1.2 ç®—æ³•å®ç°

**æºç ä½ç½®**ï¼š`stage/vstage.py:367-404`

```python
def parse_vstage(root_cfg, cfg, workspace, tool_read_text, prefix=""):
    """é€’å½’è§£æ Stage é…ç½®"""
    if cfg is None:
        return []

    ret = []
    for i, stage in enumerate(cfg):
        # è®¡ç®—å½“å‰ Stage çš„ç´¢å¼•
        index = i + 1

        # é€’å½’è§£æå­ Stage
        substages = parse_vstage(
            root_cfg,
            stage.get_value('stage', None),  # è·å–å­ Stage é…ç½®
            workspace,
            tool_read_text,
            prefix + f"{index}."             # æ‹¼æ¥ç´¢å¼•å‰ç¼€
        )

        # åˆ›å»ºå½“å‰ Stage å¯¹è±¡
        ret.append(VerifyStage(
            cfg=root_cfg,
            workspace=workspace,
            name=stage.name,
            description=stage.desc,
            task=stage.task,
            checker=stage.get_value('checker', []),
            reference_files=stage.get_value('reference_files', []),
            output_files=stage.get_value('output_files', []),
            substages=substages,             # ç»‘å®šå­ Stage
            prefix=prefix + f"{index}",      # è®¾ç½®ç´¢å¼•å‰ç¼€
            skip=stage.get_value('skip', False),
        ))

    return ret
```

### 1.3 ç®—æ³•æ‰§è¡Œè¿‡ç¨‹

**è¾“å…¥é…ç½®**ï¼š
```yaml
stage:
  - name: "APIæµ‹è¯•"
    stage:
      - name: "åŸºç¡€API"
      - name: "é«˜çº§API"
  - name: "åŠŸèƒ½æµ‹è¯•"
```

**é€’å½’è°ƒç”¨æ ‘**ï¼š
```
parse_vstage(cfg, prefix="")
â”‚
â”œâ”€ i=0, index=1, prefix="1"
â”‚  â”œâ”€ åˆ›å»º VerifyStage("APIæµ‹è¯•", prefix="1")
â”‚  â””â”€ é€’å½’è°ƒç”¨ parse_vstage(cfg[0].stage, prefix="1.")
â”‚      â”‚
â”‚      â”œâ”€ i=0, index=1, prefix="1.1"
â”‚      â”‚  â””â”€ åˆ›å»º VerifyStage("åŸºç¡€API", prefix="1.1")
â”‚      â”‚
â”‚      â””â”€ i=1, index=2, prefix="1.2"
â”‚         â””â”€ åˆ›å»º VerifyStage("é«˜çº§API", prefix="1.2")
â”‚
â””â”€ i=1, index=2, prefix="2"
   â””â”€ åˆ›å»º VerifyStage("åŠŸèƒ½æµ‹è¯•", prefix="2")
```

**è¾“å‡ºç»“æœ**ï¼š
```
VerifyStage("1-APIæµ‹è¯•")
â”œâ”€â”€ VerifyStage("1.1-åŸºç¡€API")
â””â”€â”€ VerifyStage("1.2-é«˜çº§API")
VerifyStage("2-åŠŸèƒ½æµ‹è¯•")
```

### 1.4 å…³é”®è®¾è®¡ç‚¹

1. **prefix å‚æ•°**ï¼šç”¨äºç”Ÿæˆ Stage çš„ç´¢å¼•ç¼–å·ï¼ˆå¦‚ "1.1", "1.2"ï¼‰
2. **é€’å½’ç»ˆæ­¢æ¡ä»¶**ï¼š`cfg is None` æˆ– `stage.get_value('stage', None)` è¿”å› None
3. **ç´¢å¼•è®¡ç®—**ï¼š`index = i + 1`ï¼Œä» 1 å¼€å§‹ç¼–å·ï¼ˆè€Œé 0ï¼‰
4. **çˆ¶å­å…³ç³»**ï¼šé€šè¿‡ `substages` å‚æ•°å»ºç«‹çˆ¶å­å…³ç³»

---

## ğŸ“Š 2. Stage æ ‘æ‰å¹³åŒ–ç®—æ³•

### 2.1 ç®—æ³•èƒŒæ™¯

è§£æåçš„ Stage æ˜¯æ ‘çŠ¶ç»“æ„ï¼Œä½† StageManager éœ€è¦æŒ‰é¡ºåºæ‰§è¡Œ Stageã€‚å› æ­¤éœ€è¦å°†æ ‘çŠ¶ç»“æ„æ‰å¹³åŒ–ä¸ºçº¿æ€§åˆ—è¡¨ã€‚

**å…³é”®é—®é¢˜**ï¼šå“ªäº› Stage éœ€è¦æ‰§è¡Œï¼Ÿ

**ç­”æ¡ˆ**ï¼šåªæ‰§è¡Œ**å¶å­èŠ‚ç‚¹**ï¼ˆæœ‰å®é™…ä»»åŠ¡çš„ Stageï¼‰ï¼Œè·³è¿‡**ç»„èŠ‚ç‚¹**ï¼ˆä»…ç”¨äºç»„ç»‡ç»“æ„çš„ Stageï¼‰ã€‚

### 2.2 ç»„èŠ‚ç‚¹çš„åˆ¤æ–­

**æºç ä½ç½®**ï¼š`stage/vstage.py:308-309`

```python
def is_group(self):
    """åˆ¤æ–­æ˜¯å¦ä¸ºç»„èŠ‚ç‚¹"""
    return (self.check_size == 0 and           # æ²¡æœ‰ Checker
            len(self.output_files) == 0 and    # æ²¡æœ‰è¾“å‡ºæ–‡ä»¶
            len(self.reference_files) == 0 and # æ²¡æœ‰å‚è€ƒæ–‡ä»¶
            len(self.substages) > 0)           # æœ‰å­ Stage
```

**åˆ¤æ–­é€»è¾‘**ï¼š
- ç»„èŠ‚ç‚¹ï¼šåªç”¨äºç»„ç»‡ç»“æ„ï¼Œæ²¡æœ‰å®é™…ä»»åŠ¡
- å¶å­èŠ‚ç‚¹ï¼šæœ‰å®é™…ä»»åŠ¡éœ€è¦æ‰§è¡Œ

### 2.3 æ‰å¹³åŒ–ç®—æ³•

**æºç ä½ç½®**ï¼š`stage/vstage.py:300-306`

```python
def get_substages(self) -> list[VerifyStage]:
    """é€’å½’æ”¶é›†æ‰€æœ‰å¶å­èŠ‚ç‚¹"""
    ret = []

    # é€’å½’æ”¶é›†æ‰€æœ‰å­ Stage çš„å¶å­èŠ‚ç‚¹
    for s in self.substages:
        ret.extend(s.get_substages())

    # å¦‚æœå½“å‰èŠ‚ç‚¹ä¸æ˜¯ç»„èŠ‚ç‚¹ï¼Œæ·»åŠ è‡ªå·±
    if not self.is_group():
        ret.append(self)

    return ret
```

### 2.4 ç®—æ³•æ‰§è¡Œè¿‡ç¨‹

**è¾“å…¥æ ‘**ï¼š
```
Root (ç»„èŠ‚ç‚¹)
â”œâ”€â”€ 1. APIæµ‹è¯• (ç»„èŠ‚ç‚¹)
â”‚   â”œâ”€â”€ 1.1 åŸºç¡€API (å¶å­èŠ‚ç‚¹)
â”‚   â””â”€â”€ 1.2 é«˜çº§API (å¶å­èŠ‚ç‚¹)
â””â”€â”€ 2. åŠŸèƒ½æµ‹è¯• (å¶å­èŠ‚ç‚¹)
```

**é€’å½’è°ƒç”¨è¿‡ç¨‹**ï¼š
```
Root.get_substages()
â”‚
â”œâ”€ éå† substages[0] (1. APIæµ‹è¯•)
â”‚  â””â”€ 1.get_substages()
â”‚     â”‚
â”‚     â”œâ”€ éå† substages[0] (1.1 åŸºç¡€API)
â”‚     â”‚  â””â”€ 1.1.get_substages()
â”‚     â”‚     â”œâ”€ substages ä¸ºç©ºï¼Œè·³è¿‡å¾ªç¯
â”‚     â”‚     â”œâ”€ 1.1 ä¸æ˜¯ç»„èŠ‚ç‚¹ â†’ æ·»åŠ è‡ªå·±
â”‚     â”‚     â””â”€ è¿”å› [1.1]
â”‚     â”‚
â”‚     â”œâ”€ éå† substages[1] (1.2 é«˜çº§API)
â”‚     â”‚  â””â”€ 1.2.get_substages()
â”‚     â”‚     â”œâ”€ substages ä¸ºç©ºï¼Œè·³è¿‡å¾ªç¯
â”‚     â”‚     â”œâ”€ 1.2 ä¸æ˜¯ç»„èŠ‚ç‚¹ â†’ æ·»åŠ è‡ªå·±
â”‚     â”‚     â””â”€ è¿”å› [1.2]
â”‚     â”‚
â”‚     â”œâ”€ ret = [1.1, 1.2]
â”‚     â”œâ”€ 1 æ˜¯ç»„èŠ‚ç‚¹ â†’ ä¸æ·»åŠ è‡ªå·±
â”‚     â””â”€ è¿”å› [1.1, 1.2]
â”‚
â”œâ”€ éå† substages[1] (2. åŠŸèƒ½æµ‹è¯•)
â”‚  â””â”€ 2.get_substages()
â”‚     â”œâ”€ substages ä¸ºç©ºï¼Œè·³è¿‡å¾ªç¯
â”‚     â”œâ”€ 2 ä¸æ˜¯ç»„èŠ‚ç‚¹ â†’ æ·»åŠ è‡ªå·±
â”‚     â””â”€ è¿”å› [2]
â”‚
â”œâ”€ ret = [1.1, 1.2, 2]
â”œâ”€ Root æ˜¯ç»„èŠ‚ç‚¹ â†’ ä¸æ·»åŠ è‡ªå·±
â””â”€ è¿”å› [1.1, 1.2, 2]
```

**è¾“å‡ºåˆ—è¡¨**ï¼š
```python
stages = [
    VerifyStage("1.1-åŸºç¡€API"),
    VerifyStage("1.2-é«˜çº§API"),
    VerifyStage("2-åŠŸèƒ½æµ‹è¯•")
]
```

### 2.5 å…³é”®è®¾è®¡ç‚¹

1. **ååºéå†**ï¼šå…ˆé€’å½’å­èŠ‚ç‚¹ï¼Œå†å¤„ç†å½“å‰èŠ‚ç‚¹
2. **ç»„èŠ‚ç‚¹è¿‡æ»¤**ï¼šç»„èŠ‚ç‚¹ä¸æ·»åŠ åˆ°ç»“æœåˆ—è¡¨
3. **é¡ºåºä¿è¯**ï¼šæ·±åº¦ä¼˜å…ˆéå†ä¿è¯äº†æ‰§è¡Œé¡ºåº
4. **æ‰å¹³åŒ–ç»“æœ**ï¼šStageManager ä½¿ç”¨æ‰å¹³åŒ–åçš„åˆ—è¡¨ï¼Œé€šè¿‡ `stage_index` é¡ºåºæ‰§è¡Œ

---

## ğŸ“¦ 3. æ‰¹å¤„ç†ä»»åŠ¡ç®¡ç†ç®—æ³•

### 3.1 ç®—æ³•èƒŒæ™¯

åœ¨éªŒè¯è¿‡ç¨‹ä¸­ï¼Œç»å¸¸éœ€è¦ç”Ÿæˆå¤§é‡æµ‹è¯•ç”¨ä¾‹ï¼ˆä¾‹å¦‚ 30 ä¸ªï¼‰ã€‚å¦‚æœä¸€æ¬¡æ€§è®© LLM ç”Ÿæˆæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œä¼šå¯¼è‡´ï¼š
1. è¾“å‡ºè¿‡é•¿ï¼Œå®¹æ˜“å‡ºé”™
2. éš¾ä»¥è¿½è¸ªè¿›åº¦
3. å¤±è´¥åéœ€è¦é‡æ–°ç”Ÿæˆæ‰€æœ‰ç”¨ä¾‹

å› æ­¤ï¼ŒUCAgent é‡‡ç”¨**æ‰¹å¤„ç†**ç­–ç•¥ï¼šå°†ä»»åŠ¡åˆ†æˆå¤šä¸ªæ‰¹æ¬¡ï¼Œæ¯æ¬¡åªç”Ÿæˆä¸€å°éƒ¨åˆ†ï¼ˆä¾‹å¦‚ 10 ä¸ªï¼‰ã€‚

### 3.2 æ ¸å¿ƒæ•°æ®ç»“æ„

**æºç ä½ç½®**ï¼š`checkers/base.py:309-550`

```python
class UnityChipBatchTask:
    """æ‰¹å¤„ç†ä»»åŠ¡ç®¡ç†å™¨"""

    def __init__(self, name: str, checker: Checker):
        self.name = name                # ä»»åŠ¡ç±»å‹åç§°
        self.checker = checker          # å…³è”çš„ Checker

        # å››ä¸ªæ ¸å¿ƒåˆ—è¡¨
        self.source_task_list = []      # ç›®æ ‡ä»»åŠ¡ï¼ˆæ¥è‡ªé…ç½®ï¼‰
        self.gen_task_list = []         # å·²ç”Ÿæˆä»»åŠ¡ï¼ˆå®é™…å®Œæˆï¼‰
        self.tbd_task_list = []         # å¾…å®Œæˆä»»åŠ¡ï¼ˆå½“å‰æ‰¹æ¬¡ï¼‰
        self.cmp_task_list = []         # å·²å®Œæˆä»»åŠ¡ï¼ˆå½“å‰æ‰¹æ¬¡ï¼‰

        self.batch_size = 10            # æ‰¹æ¬¡å¤§å°
```

**å››ä¸ªåˆ—è¡¨çš„å…³ç³»**ï¼š
```
source_task_list: [test1, test2, ..., test30]  # ç›®æ ‡ï¼š30ä¸ªæµ‹è¯•
gen_task_list:    [test1, ..., test10]         # å·²ç”Ÿæˆï¼š10ä¸ª
tbd_task_list:    [test11, ..., test20]        # å½“å‰æ‰¹æ¬¡ï¼š10ä¸ª
cmp_task_list:    [test11, test12]             # å½“å‰æ‰¹æ¬¡å·²å®Œæˆï¼š2ä¸ª
```

---

**ä¸‹ä¸€ç« **ï¼š [04-execution-flow.md](./04-execution-flow.md)